{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
  Pesanan - CoffeeShop
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/pesanan.css' %}" />
{% endblock %}

{% block content %}
  <div class="pesanan-container">
    <h2 class="text-center mb-4"><i class="fas fa-mug-hot me-2"></i> Pesanan Aktif</h2>

    {% if orders %}
      <table>
        <thead>
          <tr>
            <th>No</th>
            <th>Foto</th>
            <th>Nama Produk</th>
            <th>Jumlah</th>
            <th>Harga</th>
            <th>Subtotal</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>
                {% if order.menu and order.menu.gambar %}
                  <img src="{{ order.menu.gambar.url }}" alt="{{ order.menu.nama }}" style="max-width: 100px; max-height: 80px; object-fit: contain; border-radius: 5px;" />
                {% else %}
                  Tidak ada foto
                {% endif %}
              </td>
              <td>{{ order.menu.nama|default:"(Menu tidak tersedia)" }}</td>
              <td>{{ order.jumlah }}</td>
              <td>Rp {{ order.harga|intcomma }}</td>
              <td>Rp {{ order.total|intcomma }}</td>
              <td>
                {% if order.status == 'proses' %}
                  <span class="badge-status proses">‚è≥ Sedang diproses</span>
                {% elif order.status == 'selesai' %}
                  <span class="badge-status selesai">‚úÖ Selesai</span>
                {% else %}
                  <span class="badge-status aktif">‚è±Ô∏è Menunggu</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="text-end total-harga">Total Keseluruhan: Rp {{ total_harga|intcomma }}</div>
    {% else %}
      <p class="text-center text-muted">Belum ada pesanan aktif.</p>
    {% endif %}
  </div>

  <hr class="my-5" />

  <h4 class="text-center">Konfirmasi Pembayaran</h4>

  {% if transaksi %}
    <div class="text-center">
      <p>Total Pembayaran: <strong>Rp {{ transaksi.total|intcomma }}</strong></p>

      {% if transaksi.bukti_pembayaran %}
        <img src="{{ transaksi.bukti_pembayaran.url }}" alt="Bukti Pembayaran" style="max-height: 200px;"><br><br>
      {% else %}
        <img src="{% static 'images/qr_dana.png' %}" alt="QR DANA" style="width: 200px;"><br>
        <p class="mt-2">Transfer ke DANA <strong>082251409098</strong>, lalu upload bukti di bawah:</p>

        <form method="post" enctype="multipart/form-data" class="d-inline-block mt-3 text-start">
          {% csrf_token %}
          {{ form.as_p }}
          <button type="submit" class="btn btn-success mt-2">Kirim Bukti</button>
        </form>
      {% endif %}

      <div class="mt-3">
        {% if transaksi.status == 'verifikasi' %}
          <div class="badge bg-warning text-dark">üü° Menunggu Verifikasi Admin</div>
        {% elif transaksi.status == 'disetujui' %}
          <div class="badge bg-success">‚úÖ Pembayaran Disetujui</div>
        {% elif transaksi.status == 'ditolak' %}
          <div class="badge bg-danger">‚ùå Pembayaran Ditolak</div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <p class="text-center text-muted">Belum ada transaksi yang bisa dibayar.</p>
  {% endif %}
{% endblock %}
